<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Work Hours - Admin View</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-bold text-center text-blue-700 mb-10">Employee Work Hours</h1>

<!-- Employee Dropdown -->
<div class="mb-10">
  <label class="block text-lg text-gray-700 font-semibold mb-2">Log Hours</label>
  <select id="employeeSelect" onchange="redirectToLog()" class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-400 focus:outline-none">
    <option value="" disabled selected>Select</option>
    <% employees
      .filter(emp => !emp.is_admin)
      .sort((a, b) => (a.full_name || a.name).localeCompare(b.full_name || b.name))
      .forEach(emp => { %>
        <option value="<%= emp.id %>"><%= emp.full_name || emp.name %></option>
    <% }) %>
  </select>
</div>

<!-- Employee Work Cards -->
<div class="space-y-10">
  <% 
    employees
      .filter(emp => !emp.is_admin)
      .sort((a, b) => (a.full_name || a.name).localeCompare(b.full_name || b.name))
      .forEach(emp => {
        const empId = emp.id;
        const displayName = emp.full_name || emp.name;
        const entries = workHours
          .filter(e => e.employee_id === empId)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (entries.length === 0) return;
  %>
    <div class="bg-white shadow rounded-xl p-6">
      <button onclick="toggleLogs('<%= empId %>')" class="w-full text-left">
        <h2 class="text-xl sm:text-2xl font-semibold text-blue-600 hover:underline"><%= displayName %></h2>
      </button>

      <div id="logs-<%= empId %>" class="hidden mt-4">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-4 py-2 text-left font-semibold">Date</th>
                <th class="px-4 py-2 text-left font-semibold">Project</th>
                <th class="px-4 py-2 text-left font-semibold">Description</th>
                <th class="px-4 py-2 text-right font-semibold">Hours</th>
                <th class="px-4 py-2 text-center font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="logs-body-<%= empId %>" class="bg-white divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div id="pagination-<%= empId %>" class="mt-4 flex gap-2 flex-wrap"></div>
      </div>

      <script>
        window.logsData = window.logsData || {};
        window.logsData['<%= empId %>'] = <%- JSON.stringify(entries) %>;
      </script>
    </div>
  <% }) %>
</div>

    <!-- Back Button -->
    <div class="text-center mt-14">
      <a href="/dashboard" class="inline-block bg-green-600 hover:bg-green-700 text-white text-lg font-medium px-6 py-3 rounded-xl transition">Back to Dashboard</a>
    </div>
  </div>

  <script>
    function redirectToLog() {
      const selectedId = document.getElementById("employeeSelect").value;
      if (selectedId) {
        window.location.href = `/admin/log-hours/${selectedId}`;
      }
    }

    function toggleLogs(empId) {
      const container = document.getElementById(`logs-${empId}`);
      container.classList.toggle("hidden");
      if (!container.dataset.loaded) {
        renderLogs(empId, 1);
        container.dataset.loaded = true;
      }
    }

function renderLogs(empId, page) {
  const logs = window.logsData[empId] || [];
  const body = document.getElementById(`logs-body-${empId}`);
  const pagDiv = document.getElementById(`pagination-${empId}`);
  const entriesPerPage = 7;
  const totalPages = Math.ceil(logs.length / entriesPerPage);
  const start = (page - 1) * entriesPerPage;
  const entries = logs.slice(start, start + entriesPerPage);

  body.innerHTML = "";

  entries.forEach(entry => {
    const date = new Date(entry.date).toISOString().split('T')[0];
    let projects = [];
    try {
      projects = typeof entry.projects === 'string' ? JSON.parse(entry.projects) : entry.projects;
    } catch (e) {
      projects = [];
    }

    const totalHours = projects.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0);

    projects.forEach((p, i) => {
      const row = document.createElement("tr");

      row.innerHTML = `
        ${i === 0 ? `
          <td class="px-4 py-2 whitespace-nowrap align-top bg-gray-50 border-t border-b border-gray-200" rowspan="${projects.length}">
            <div class="flex flex-col">
              <span class="font-semibold">${date}</span>
              <span class="text-xs mt-1 text-gray-600 bg-blue-100 rounded px-2 py-0.5 inline-block w-fit">Total: ${totalHours} hrs</span>
            </div>
          </td>` : ''
        }
        <td class="px-4 py-2 whitespace-nowrap align-top">${p.name}</td>
        <td class="px-4 py-2 align-top">${p.description || 'N/A'}</td>
        <td class="px-4 py-2 text-right align-top">${p.hours} hrs</td>
${i === 0 ? `
  <td class="px-4 py-2 text-center align-top" rowspan="${projects.length}">
    <div class="flex items-center justify-center gap-2">
      <a href="/admin/edit-hours/${entry.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</a>
      <button onclick="deleteEntry('${entry.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
    </div>
  </td>
` : ''}
      `;
      body.appendChild(row);
    });
  });

  // Pagination buttons
  pagDiv.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.className = "px-3 py-1 bg-gray-200 hover:bg-blue-600 hover:text-white rounded text-sm font-medium";
    btn.innerText = i;
    btn.onclick = () => renderLogs(empId, i);
    pagDiv.appendChild(btn);
  }
}

function deleteEntry(entryId) {
  if (confirm("Are you sure you want to delete this log entry?")) {
    window.location.href = `/delete-hours/${entryId}`;
  }
}

  </script>
</body>
</html>
